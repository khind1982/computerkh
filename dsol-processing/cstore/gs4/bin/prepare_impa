#!/usr/local/bin/bash

# We need to use bash instead of plain old sh because of
# the use of pattern substitution when copying backfiles.

# Remove previous working copies of IIMP/IIPA XML files
# from the /dc/scratch/steadystate/src direcotries, and
# copy in the latest versions from their legacy build
# locations.

# As a bonus, we can also immediately call feedreq to 
# generate the full text feed request file.

SSWRKDIR=/dc/dsol/steadystate/src
LEGACYROOT=/products/impa/build

umask 002

for product in iimp iipa
do
    echo -n "Clearing out previous ${product} data..." >&2
    rm -f ${SSWRKDIR}/${product}/JID*
    echo " Done." >&2

    BACKFILES=${LEGACYROOT}/legacy_backfiles/${product}/output
    echo -n "Copying ${product} backfiles..." >&2
    for file in ${BACKFILES}/JID*
    do
        cp ${file} ${SSWRKDIR}/${product}/`basename ${file//.xml/_bf.xml}`
    done
    echo " Done." >&2

    LATEST=`find ${LEGACYROOT}/[0-9]* -type d -prune | tail -1`/${product}/output
    echo -n "Copying main files from ${LATEST}..." >&2
    for file in ${LATEST}/JID*
    do
        cp ${file} ${SSWRKDIR}/${product}/
    done
    echo " Done." >&2

    echo -n "Fixing permissions on files..." >&2
    chmod g+w "${SSWRKDIR}/${product}/*.xml"
    echo " Done." >&2
done

`dirname $0`/feedreq -u
