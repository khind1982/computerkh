#!/usr/bin/env python2.7
# -*- mode: python -*-
# pylint: disable = F0401

import datetime
import os
import sys

sys.path.insert(0, os.path.join(os.path.dirname(__file__), '../lib'))

from collections import defaultdict
from optparse import OptionParser

from commonUtils.fileUtils import buildLut, locate
from commonUtils.listUtils import uniq_sort

parser = OptionParser()
parser.add_option("-d", "--dir", dest="deldir",
                  help="Target directory for files",
                  metavar="DIR")
(options, args) = parser.parse_args()

if options.deldir is None:
    options.deldir = os.getcwd()

try:
    delbatch = args[0]
    outfname = "%s_delivery.log" % delbatch
except IndexError:
    print "Please specify a delivery batch ID"
    parser.print_help()
    exit(1)

titles = buildLut('pmid-title.lut')
batchdate = datetime.datetime.today().strftime('%d/%m/%Y')

# imagedata is a defaultdict, whose default value is a defaultdict
# whose default value is the empty list. Sweet!
imagedata = defaultdict(lambda: defaultdict(list))

# Iterate over the files returned by locate(), and create a dictionary
# key for each jid, where the value is a dictionary of images and
# years covered in the batch for the journal.
for image in [os.path.basename(image) for image in locate('*.jpg', options.deldir)]:
    jid = image.split('_')[0]
    image_year = image.split('_')[1][0:4]
    imagedata[jid]['images'].append(image)
    imagedata[jid]['years'].append(image_year)

with open(outfname, 'w') as outf:
    # to keep track of the total number of pages in the batch
    total_page_count = 0
    for jid in sorted(imagedata.keys()):
        pcount = len(imagedata[jid]['images'])
        total_page_count += pcount
        years = ', '.join(uniq_sort(imagedata[jid]['years']))
        outline = "{jid}\t{title}\t{batchid}\t{deldate}\t{pagecount}\t{years}\n".format(
            jid=jid, title=titles[jid], batchid=delbatch,
            deldate=batchdate, pagecount=pcount, years=years)
        outf.write(outline)
    outf.write("Total Page Count:\t\t\t\t %i" % total_page_count)
