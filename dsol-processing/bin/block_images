#!/usr/local/bin/bash

# given a file containing document IDs and images to block,
# make the necessary changes to the threading database for the
# product.

case $# in
    2)
        product=$1
        infile=$2
        ;;
    *)
        echo "Usage: $(basename $0) product list_of_ids"
        exit 1
esac

dbhosts="mysql-server chsys102"

# Basic sanity checking, so we don't completely screw the 
# threading database.

# 
for host in $dbhosts
do
    mysql -u root -h $host $product < <(sed -e 's!|! !; s!\(.*\)_.... \(.*\)!UPDATE pagecollection_threading SET path = "/blocked_images/scaled/blocked_image.jpg" WHERE pcid = "\1" AND path LIKE "%\2" AND type = "SCALED_IMG";!' < "${infile}")

    mysql -u root -h $host $product < <(sed -e 's!|! !; s!\(.*\) \(.*\)!UPDATE threading SET path = "/blocked_images/jpeg/blocked_image.jpg" WHERE aid = "\1" AND path LIKE "%\2";!' < "${infile}")
done
