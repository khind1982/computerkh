#!/usr/local/bin/python2.6
# -*- mode: python -*-

import os, sys
from os.path import join

sys.path.append(os.path.join(os.path.dirname(__file__) + '/../lib/python'))

from  xml_validation_check import *


if __name__ == '__main__':
    #have we a configuration file?
    if os.path.isfile('xml.cfg'):
        open_cfg = open('xml.cfg', 'rU')
        read_cfg = open_cfg.read()
        read_cfg = read_cfg.replace('self','a')
    error_log = open('validation.log', 'w')
    for (path, dirs, files) in os.walk('./'):
        dirs.sort()
        print path
        for name in sorted(files):
            if name.find('.xml') != -1:
                fullname = os.path.join(path, name)
                print fullname
                errorlist = []
                a = Validation()
                #we have a configuration file
                if os.path.isfile('xml.cfg'):
                    a.tagfuncs = eval(read_cfg)
                #if the encoding is latin-1 the command will be check xml latin-1
                if len(sys.argv) == 2:
                    encoding=sys.argv[1]
                else:
                    encoding='utf-8'
                error_list = a.check_file(fullname,encoding)
                if error_list:
                    error_log.write(fullname + ':\n')
                    for x in error_list:
                        error_log.write(x.encode('latin-1') + '\n')
                    error_log.write('-------------------------\n')           
