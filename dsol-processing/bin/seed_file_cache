#!/usr/local/bin/python2.7
# -*- mode: python -*-

# Seed the initial file checksum caches for IIMP and IIPA.
# We need a copy for each variant, so we don't need to worry
# about multiple processes accessing the same file.

import glob
import hashlib
import os
import sys
sys.path.append(os.path.join(os.path.dirname(__file__), '..', 'lib'))

from confreader import ConfReader
from dbcache import DBCacheManager

appconf = ConfReader()

try:
    product_key = sys.argv[1]
    path = sys.argv[2]
except IndexError:
    print "Not enough arguments:"
    print "%s <product> <path>" % os.path.basename(__file__)

product = product_key.replace('ft', '')

cachefile = DBCacheManager(
    context='filecache',
    cachetype='filecache',
    filename=os.path.join(appconf.get(product, 'ssroot'), '%s.file_checksums' % product_key)
)

for f in sorted(glob.glob('%s/JID*.xml' % path)):
    checksum = hashlib.sha256(''.join([line for line in open(f, 'r').readlines() if "UPDATED" in line])).hexdigest()
    jid = os.path.basename(f)
    cachefile[jid] = checksum
    
