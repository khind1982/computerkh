#!/usr/local/bin/python2.6
import site
site.addsitedir('/packages/dsol/lib/python2.6/site-packages')
import os, sys
from datetime import datetime
sys.path.append(os.path.join(os.path.dirname(__file__) + '/../lib/python'))
from knowuk.willings import *
from  miscUtils import *

if __name__ == '__main__':
	if os.path.isfile('willings.end'):
		os.remove('willings.end')
	xmlout = open('willings.end','w')
	xmlout.write('<vol type="ARTS" logo="/images/logos/willings.gif" copyrght="Copyright material reproduced under licence from Romeike Ltd" source="WILLINGS" publ="Romeike Ltd" pname="Willings Press Guide" toc="Y" freq="annually" lordate="'+datetime.now().strftime("%B %Y")+'">\n')
	xsl = sys.argv[1]
	#From now on there will be only one type of file to process (publication)
	converted_file = csv2xml(xsl)
	open_xml = open(converted_file,'rU')
	read_xml = open_xml.read().decode('latin-1')
	read_xml = re.sub('(\n)\s+(\n)', '\\1\\2', read_xml)
	read_xml = re.sub('\n{2,}', '', read_xml)
	record_rgx = re.compile('<record>.*?</record>', re.DOTALL)
	wrong_tag_rgx = re.compile('</(.*)>')
	wrong_tag = wrong_tag_rgx.findall(read_xml)
	wrong_tag = list(set(wrong_tag))
	for tag in wrong_tag:
		new_tag = tag.replace('/', '_slash_').replace('(', '_op_').replace(')', '_cp_').replace('&', '_amp_')
		read_xml = read_xml.replace(tag, new_tag)
	record_set=remove_empty_fields(record_rgx.findall(read_xml))
	type_rgx = re.compile('<Outlet_Media_Type>.*?</Outlet_Media_Type>')
	type_list = sorted(list(set(remove_empty_fields(type_rgx.findall(read_xml)))))
	for record_type in type_list:
		first_record = 'yes'
		for record in record_set:
			if record.find(record_type)!= -1:
				record = re.sub('(Outlet_Street_Address)(.*?)(>)', '\\1\\3', record)
				wllg = willing_record(record, first_record,xmlout)
				first_record = wllg.process_publications()
	xmlout.write('</vol>')
	xmlout.close()





	
