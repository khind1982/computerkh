#!/usr/bin/env bash
# -*- mode: shell-script -*-

# Recurse into a directory using `find', or read a list of image
# filenames from a file, and print out any lines that don't
# match the pattern.

# Set an exit status when finishing. If we found any badly
# formatted files, signal an error with exit status 1.
# Otherwise, exit with 0

EXIT=0

check_file() {
    INF="${1}"
    while read -r imgname
    do
        do_check "${imgname}"
    done < "${INF}"
}

check_dir() {
    DIR="${1}"
    for f in `find "${DIR}" -name '*.jpg' -o -name '*.jp2' | sort`
    do
        do_check "${f}"
    done
}

do_check() {
    TARGET="${1}"
    if ! (echo "${TARGET##*/}" | egrep "TRJ....._........-...\.jp(2|g)$" 2>&1 > /dev/null)
    then
        echo "${TARGET}"
        EXIT=1
    fi
}

case $# in
     1)
        if [ -f "${1}" ]
        then
            check_file "${1}"
        else
            check_dir "${1}"
        fi
        ;;
     *)
        echo "Usage: $0 [directory_name|file_list]" >&2
        exit 1
        ;;
esac

exit ${EXIT}
